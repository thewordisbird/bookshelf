{% extends 'base.html' %}
{% block style %}
<style>
   
    .description-container {
        padding-bottom: 10px !important;
        /*border-bottom: 1px solid #D8D8D8;*/
    }

    .review-container {
        
        padding-bottom: 10px !important;
        /*border-bottom: 1px solid #D8D8D8;*/
    }

    .cover-img {
        margin-top: 2rem;
    }

    .user-img {
        border-radius: 50%;
        margin-top: 1rem;
    }

    .star-rating li {
        display: inline;
    }

    .tiny-small {
        font-size: 1.5rem;
    }

    .star-icon {
        position: relative;
        top: 5px;
        color: black;
    }

    .create-icon {
    position: relative;
    top: 5px;
    color:black;

}
    
    .set-review {
        cursor: pointer;
    }
    
    .divider {
        width: 100%;
        margin-top: 10px;
        margin-bottom: 10px !important;
        border-bottom: 1px solid #D8D8D8;
    }

    .status-btn {
        width: 95%
        
    }

    .display-section-header {
        padding-bottom: 10px !important;
        border-bottom: 1px solid #D8D8D8;
    }
</style>
{% endblock %}

{% block title %}{{title}}{% endblock %}

{% block content %}
<div class="container">
    <div class="row ">
        <div class="col m10 offset-m1 description-container">
            <div class="col m2">
                <img class="cover-img" src="{{ book['volumeInfo']['imageLinks']['thumbnail'] }}">
                
                {% if not book_user_info.date_rated %}
                    {% if not book_user_info.date_finished %}
                    <ul class="star-rating center-align">
                        <a href="{{ url_for('books.new_review' , book_id=book.id, rating=1) }}"><i value="1" class="material-icons star-icon tiny-small set-review" >star_border</i></a>
                        <a href="{{ url_for('books.new_review' , book_id=book.id, rating=2) }}"><i value="2" class="material-icons star-icon tiny-small set-review" >star_border</i></a>
                        <a href="{{ url_for('books.new_review' , book_id=book.id, rating=3) }}"><i value="3" class="material-icons star-icon tiny-small set-review" >star_border</i></a>
                        <a href="{{ url_for('books.new_review' , book_id=book.id, rating=4) }}"><i value="4" class="material-icons star-icon tiny-small set-review" >star_border</i></a>
                        <a href="{{ url_for('books.new_review' , book_id=book.id, rating=5) }}"><i value="5" class="material-icons star-icon tiny-small set-review" >star_border</i></a>
                    </ul>
                    <a href="{{ url_for('books.new_review', book_id=book.id) }}" class="status-btn waves-effect waves-light btn center-align">Leave Review</a>
                    <div class="divider"></div>
                    
                    <div id="statusContainer">
                        {% if book_user_info.date_started %}
                            Started Reading {{ book_user_info.date_started.strftime('%m/%d/%y')}}
                        {% else %}
                            <button id="btnReading" class="status-btn waves-effect waves-light btn center-align" type="submit" name="action" value="{{ book.id }}">Reading</button>
                        {% endif %}
                        
                    </div>
                    {% endif %}
                {% endif %}
                
            </div>
            <div class="col m10">
                <h4>{{ book['volumeInfo']['title'] }}</h4>
                <span class="author">{{ ', '.join(book['volumeInfo']['authors']) }}</span><br>
                <span class="description">{{ book['volumeInfo']['description']|safe }}</span>                                
            </div> 
           
        </div> 
    </div>

    <!-- User Review If Availible-->
    {% if book_user_info.rating %}
    <div class="row">
        <div class="col m10 offset-m1">
            <div class="display-section-header">
                YOUR REVIEW:
            </div>
        </div>
    </div>
    
    <div class="row ">
        <div class="col m10 offset-m1 review-container">
            <div class="col m2">
                <img class="user-img" src="https://via.placeholder.com/150">
            </div>
            <div class="col m10 ">
                <div class="row">
                    <div class="col m12">
                        <a href="{{url_for('books.profile', user_id=book_user_info.uid)}}">You</a> rated it <span class="star-rated">
                            {% for i in range(book_user_info.rating | int) %}
                                <i class="material-icons star-icon tiny-small" >star</i>
                            {% endfor %}
                            {% for j in range(book_user_info.rating | int, 5) %}
                                <i class="material-icons star-icon tiny-small" >star_border</i>
                            {% endfor %}
                        </span>
                        <!--Update to date created when fixed-->
                        on {{ book_user_info.date_rated.strftime('%b %d, %Y') }} <a href="#"><i class="material-icons create-icon">create</i></a>
                    </div>
                    <div class="col m12 review-title">
                        <h6>{{ book_user_info.review_title }}</h6>
                    </div>
                    <div class="col m12 review-content">
                        {{ book_user_info.review_content }}
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- Reviews will go below-->
    {% if book_reviews %}
    <div class="row">
        <div class="col m10 offset-m1">
            <div class="display-section-header">
                ALL REVIEWS:
            </div>
        </div>
    </div>
    {% endif %}
    
    {% for book_review in book_reviews %}
        {% if 'date_rated' in book_review %}
            <div class="row ">
                <div class="col m10 offset-m1 review-container">
                    <div class="col m2">
                        <img class="user-img" src="https://via.placeholder.com/150">
                    </div>
                    <div class="col m10 ">
                        <div class="row">
                            <div class="col m12">
                                <a href="{{url_for('books.profile', user_id=book_review.uid)}}">{{ book_review.display_name }}</a> rated it <span class="star-rated">
                                    {% for i in range(book_review.rating | int) %}
                                        <i class="material-icons star-icon tiny-small" >star</i>
                                    {% endfor %}
                                    {% for j in range(book_review.rating | int, 5) %}
                                        <i class="material-icons star-icon tiny-small" >star_border</i>
                                    {% endfor %}
                                </span>
                                <!--Update to date created when fixed-->
                                on {{ book_review.date_rated.strftime('%b %d, %Y') }} 
                            </div>
                            <div class="col m12 review-title">
                                <h6>{{ book_review.review_title}}</h6>
                            </div>
                            <div class="col m12 review-content">
                                {{ book_review.review_content}}
                            </div>
                        </div>
                    </div>
                    <div class="divider"></div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('.datepicker');
      var instances = M.Datepicker.init(elems, {
          format: 'mm/dd/yyyy'});
    });
  </script>

<script>
    const ratingField = document.getElementById("rating");
    const starElements = document.getElementsByClassName("set-review");
    const stars = new Array;

    const setStars = (rating) => {
      for (let i=0; i<rating; i++) {
          stars[i].innerHTML= "star";
      };
      for (let j=rating; j<5; j++ ){
          stars[j].innerHTML="star_border";
      };
    };

    const removeStars = (rating) => {
      for (let i=rating-1; i<5; i++) {
          stars[i].innerHTML= "star_border";
      };
    };

    for (let i=0; i<starElements.length; i++) {
        starElements[i].addEventListener('click', function(){
          let starValue = this.getAttribute("value");
          if (this.innerHTML == "star_border") {
              setStars(starValue);
              ratingField.value = starValue ;
          } else {
              removeStars(starValue);
              ratingField.value = starValue - 1;
          };    
        }, false);
        stars.push(starElements[i])
    }
</script>

<script>
    const btnReading = document.getElementById('btnReading')
    const statusContainer = document.getElementById('statusContainer')
    const postReadingRequest = (bookId) => {
        return $.ajax({
          type:'POST',
          url: '/reading',
          data: {bookId: bookId},
          dataType: 'json',
          contentType: 'application/x-www-form-urlencoded'
        });
    };

    btnReading.addEventListener('click', e => {
        bookId = btnReading.value;
        postReadingRequest(bookId).then((resp) =>{
            if (resp['status'] == 'success') {
                let startDate = resp['startDate']
                statusContainer.innerHTML = "Started Reading<br>"+startDate
            }
        });
    });
</script>
{% endblock %}